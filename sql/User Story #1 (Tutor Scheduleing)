SET @TutorID := 8;
SET @MaxHoursPerWeek := 10;

-- 1. CREATE TEMPORARY NEW SLOTS TABLE
DROP TEMPORARY TABLE IF EXISTS TempNewSlots;

CREATE TEMPORARY TABLE TempNewSlots (
    DayOfWeek ENUM('Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'),
    StartTime TIME,
    EndTime   TIME
);

-- Example new slots
INSERT INTO TempNewSlots (DayOfWeek, StartTime, EndTime) VALUES
 ('Monday',    '09:00:00', '11:00:00'),
 ('Wednesday', '13:00:00', '15:00:00'),
 ('Friday',    '10:00:00', '12:00:00');

-- 2. CREATE REAL TABLE COPY FOR SELF-JOIN
DROP TABLE IF EXISTS TempSlotsCopy;

CREATE TABLE TempSlotsCopy AS
SELECT * FROM TempNewSlots;

ALTER TABLE TempSlotsCopy
ADD COLUMN SlotID INT AUTO_INCREMENT PRIMARY KEY;

-- 3. CALCULATE HOURS FOR NEW SLOTS
SELECT
    IFNULL(SUM(TIMESTAMPDIFF(MINUTE, StartTime, EndTime)) / 60.0, 0)
INTO @NewHours
FROM TempNewSlots;

-- 4. CALCULATE EXISTING HOURS
SELECT
    IFNULL(SUM(TIMESTAMPDIFF(MINUTE, StartTime, EndTime)) / 60.0, 0)
INTO @ExistingHours
FROM Availability
WHERE TutorID = @TutorID
  AND IsAvailable = TRUE;

-- 5. TOTAL HOURS AFTER UPDATE
SET @TotalHours := @NewHours + @ExistingHours;

-- 6. OVERLAP CHECK: NEW SLOTS AMONG THEMSELVES
SELECT EXISTS (
    SELECT 1
    FROM TempSlotsCopy A
    JOIN TempSlotsCopy B
      ON A.DayOfWeek = B.DayOfWeek
     AND A.StartTime < B.EndTime
     AND B.StartTime < A.EndTime
     AND A.SlotID < B.SlotID
) INTO @OverlapNew;

-- 7. OVERLAP CHECK: NEW SLOTS VS EXISTING AVAILABILITY
SELECT EXISTS (
    SELECT 1
    FROM TempNewSlots n
    JOIN Availability a
      ON a.TutorID = @TutorID
     AND a.IsAvailable = TRUE
     AND n.DayOfWeek = a.DayOfWeek
     AND n.StartTime < a.EndTime
     AND a.StartTime < n.EndTime
) INTO @OverlapExisting;

-- 8. VALIDATION LOGIC
SET @IsValid := (
    CASE
        WHEN @TotalHours <= @MaxHoursPerWeek
         AND @OverlapNew = 0
         AND @OverlapExisting = 0
        THEN 1
        ELSE 0
    END
);

-- 9. CONDITIONAL UPDATE (ATOMIC)
START TRANSACTION;

-- Delete existing availability only if valid
DELETE FROM Availability
WHERE TutorID = @TutorID
  AND @IsValid = 1;

-- Insert new availability only if valid
INSERT INTO Availability (TutorID, DayOfWeek, StartTime, EndTime, IsAvailable)
SELECT @TutorID, DayOfWeek, StartTime, EndTime, TRUE
FROM TempNewSlots
WHERE @IsValid = 1;

COMMIT;

-- 10. STATUS MESSAGE
SELECT
    CASE
        WHEN @IsValid = 1 THEN
            'SUCCESS: Availability updated.'
        WHEN @OverlapNew = 1 THEN
            'ERROR: New time slots overlap each other.'
        WHEN @OverlapExisting = 1 THEN
            'ERROR: New time slots overlap existing availability.'
        WHEN @TotalHours > @MaxHoursPerWeek THEN
            CONCAT('ERROR: Total hours (', @TotalHours,
                   ') exceed limit of ', @MaxHoursPerWeek, '.')
        ELSE
            'ERROR: Unknown validation failure.'
    END AS Message;

-- 11. SHOW UPDATED SCHEDULE (ONLY IF VALID)
SELECT
    a.TutorID,
    CONCAT(t.FirstName, ' ', t.LastName) AS Tutor,
    a.DayOfWeek,
    a.StartTime,
    a.EndTime,
    TIMESTAMPDIFF(MINUTE, a.StartTime, a.EndTime) / 60.0 AS Hours
FROM Availability a
JOIN Tutor t ON a.TutorID = t.TutorID
WHERE a.TutorID = @TutorID
  AND @IsValid = 1
ORDER BY FIELD(a.DayOfWeek,
    'Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'),
    a.StartTime;

-- 12. CLEANUP
DROP TABLE TempSlotsCopy;
